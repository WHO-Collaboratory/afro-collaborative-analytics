---
title: "Task 6: Estimating the reproduction number"
format:
  html:
    code-fold: true
execute:
  warning: false
---

## Overview

This task covers estimating the basic and effective reproduction number (R0 and Rt), as well as other relevant metrics to quantify transmissibility such as the growth rate. You will learn methods for calculating these key epidemiological metrics from outbreak data, by accounting for reporting delays and uncertainty.

## Learning Objectives

- Understand the difference between R0 and Rt
- Estimate reproduction numbers from case data
- Use appropriate methods for different data types
- Visualize and interpret reproduction number estimates

## Tutorial

[Access the tutorial here](https://epiverse-trace.github.io/tutorials-middle/quantify-transmissibility.html)


## Downloading Rt Estimates

**Note:** Running EpiNow2 can be computationally expensive and may take several minutes to complete. If you want to skip this step, you can download the pre-computed estimates file and place it in your `outputs/` folder:

<a href="outputs/rt_estimates.rds" download class="btn btn-primary" target="_blank">Download Rt estimates</a>

## Example Report

<a href="data/solutions/task6_solution.qmd" download class="btn btn-primary" target="_blank">Download solution file</a>

### Converting linelist to incidence

We first import linelist data for an Ebola outbreak that started in April 2014, convert it to incidence, and visualise the epidemic curve.

```{r}
# INSTALL AND LOAD PACKAGES
pacman::p_load(tidyverse, EpiNow2, incidence2, rio, reactable)

# LOAD DATA
# Import the cleaned linelist data
linelist <- readRDS("data/linelist.rds")

# Convert linelist to incidence and format data for EpiNow2
incidence <- linelist |>
  incidence2::incidence(
    date_index = "date_onset",
    count_values_to = "confirm",
    date_names_to = "date",
    complete_dates = TRUE
  ) |>
  # Keep the first 90 dates
  dplyr::slice_head(n = 190)

# Plotting incidence curve
plot(incidence) +
  labs(x = "Date", y = "Cases")
```

### Estimating Rt

We used {EpiNow2} to estimate the time-varying reproduction number (Rt) for 
the Ebola outbreak, accounting for reporting delays. We first defined the parameters.

```{r}
# define parameters
pars <- tibble(
  par = c("Incubation Period", "Reporting Delay", "Generation Time"),
  dist = c("Gamma", "LogNormal", "LogNormal"),
  mean = c(4, 2, 3),
  sd = c(2, 1, 2.5),
  max = c(20, 10, 15)
)

# Creating distribution objects for the incubation period, reporting delay, and
# generation time
incubation_period_fixed <- EpiNow2::Gamma(
  mean = pars$mean[1],
  sd = pars$sd[1],
  max = pars$max[1]
)

reporting_delay_fixed <- EpiNow2::LogNormal(
  mean = pars$mean[2],
  sd = pars$sd[2],
  max = pars$max[2]
)

generation_time_fixed <- EpiNow2::LogNormal(
  mean = pars$mean[3],
  sd = pars$sd[3],
  max = pars$max[3]
)

# define Rt prior distribution
rt_prior <- EpiNow2::rt_opts(
  prior = EpiNow2::LogNormal(mean = 1.5, sd = 0.2)
)

# print table
reactable(
  pars,
  columns = list(
    par = colDef(name = "Parameter"),
    dist = colDef(name = "Distribution"),
    mean = colDef(name = "Mean"),
    sd = colDef(name = "Standard Deviation"),
    max = colDef(name = "Maximum")
  )
)
```

The estimated time-varying reproduction number is visualised below.

```{r}
# check if the analysis has been run before and run EpiNow2 if not
file_name <- "outputs/rt_estimates.rds"
if (file.exists(file_name)) {
  rt_estimates <- import(file_name)
} else {
  # define cores
  withr::local_options(base::list(mc.cores = 4))
  ## generate estimates
  rt_estimates <- EpiNow2::epinow(
    # # Drop column for {EpiNow2} input format
    data = select(incidence, -count_variable),
    # delays
    generation_time = EpiNow2::generation_time_opts(generation_time_fixed),
    delays = EpiNow2::delay_opts(
      incubation_period_fixed + reporting_delay_fixed
    ),
    # prior
    rt = rt_prior,
    stan = EpiNow2::stan_opts(samples = 1000, chains = 3)
  )
  export(rt_estimates, file_name)
}

# plot reproduction number
rt_estimates$plots$R
```

Key summary statistics are provided below:

```{r}
# generate an interactive table
reactable(
  summary(rt_estimates),
  columns = list(
    measure = colDef(name = "Measure"),
    estimate = colDef(name = "Estimate")
  )
)
```