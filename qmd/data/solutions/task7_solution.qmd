---
title: "Task 7 Solution"
format:
  html
execute:
  echo: false
  warning: false
  message: false
---


### Visualising available epiparameter distributions

 We first explore the available distributions in {epiparameter} that we can 
 use to adjust for delays during an Ebola outbreak.

```{r}
# INSTALL AND LOAD PACKAGES
pacman::p_load(tidyverse, EpiNow2, incidence2, reactable, rio)

# List distributions
epiparameter::epiparameter_db(disease = "ebola") |>
  epiparameter::parameter_tbl() |>
  select(-disease) |>
  reactable::reactable(defaultPageSize = 5)
```

### Extracting relevant parameters and adjusting for delays

We imported linelist data for the Ebola outbreak, and converted it to incidence.
Then extracted parameter distributions for the serial interval and incubation
period for Ebola, chosen from the table above.

```{r}
# LOAD DATA
# Import linelist data and convert to incidence
ebola_incidence <- readRDS("data/linelist.rds") |>
  incidence2::incidence(
    date_index = "date_onset",
    count_values_to = "confirm",
    date_names_to = "date",
    complete_dates = TRUE
  ) |>
  dplyr::select(-count_variable)

# serial interval ---------------------------------------------------------

# subset one distribution for the SI
ebola_serial <- epiparameter::epiparameter_db(
  disease = "ebola",
  epi_name = "serial",
  single_epiparameter = TRUE
)

# adapt SI epiparameter object to EpiNow2
ebola_serial_discrete <- epiparameter::discretise(ebola_serial)

serial_interval_ebola <-
  EpiNow2::Gamma(
    mean = ebola_serial$summary_stats$mean,
    sd = ebola_serial$summary_stats$sd,
    max = quantile(ebola_serial_discrete, p = 0.99)
  )

# incubation period ---------------------------------------------------------

# subset one distribution for ebola incubation period
ebola_incubation <- epiparameter::epiparameter_db(
  disease = "ebola",
  epi_name = "incubation",
  single_epiparameter = TRUE
)

# adapt IP epiparameter object to EpiNow2
ebola_incubation_discrete <- epiparameter::discretise(ebola_incubation)

incubation_period_ebola <-
  EpiNow2::Gamma(
    mean = ebola_incubation$summary_stats$mean,
    sd = ebola_incubation$summary_stats$sd,
    max = quantile(ebola_serial_discrete, p = 0.99)
  )

# reporting delay ---------------------------------------------------------
reporting_delay <- EpiNow2::LogNormal(
  mean = 2,
  sd = 1,
  max = 10
)

# check if the analysis has been run before and run EpiNow2 if not
file_name <- "outputs/nowcast_estimates.rds"
if (file.exists(file_name)) {
  nowcast_estimates <- import(file_name)
} else {
  # nowcasting with epinow ---------------------------------------------------
  withr::local_options(base::list(mc.cores = 4))
  nowcast_estimates <- EpiNow2::estimate_infections(
    data = ebola_incidence,
    generation_time = EpiNow2::generation_time_opts(serial_interval_ebola),
    delays = EpiNow2::delay_opts(incubation_period_ebola + reporting_delay),
    forecast = NULL,
    stan = EpiNow2::stan_opts(samples = 500, chains = 2)
  )
  export(nowcast_estimates, file_name)
}

```

We then adjust for a reporting delay of 2 days from onset to notification, on average.

```{r}
plot(nowcast_estimates, type = "infections")
```
