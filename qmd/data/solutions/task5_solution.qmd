---
title: "Task 5 Solution"
format:
  html
execute:
  echo: false
  warning: false
  message: false
---


# Visualising incidence and death data

We estimate disease severity during an outbreak of Ebola in 2014.
Firstly, we visualise case incidence and deaths across the entire available data from the outbreak (2014-2015).


```{r}
# INSTALL AND LOAD PACKAGES
pacman::p_load(tidyverse, cfr, epiparameter, reactable)

# LOAD DATA
ebola_cases_deaths <- readRDS("data/linelist.rds") %>%
  # Create date_death column: use date_outcome for entries where outcome == "Death"
  mutate(date_death = if_else(outcome == "Death", date_outcome, as.Date(NA))) %>%
  incidence2::incidence(
    date_index = c("date_onset", "date_death"),
    date_names_to = "date",
    complete_dates = TRUE
  )

plot(ebola_cases_deaths)

```

## Estimating Case Fatality Risk (CFR) in real-time

To estimate the static CFR at a specific time-point during the outbreak, we subset the data to include the initial 150 days of the outbreak only. Then we estimate both the naive and the delay-adjusted CFR.

```{r}
# Prepare data for {cfr} package
ebola_data_cfr <- ebola_cases_deaths %>%
  pivot_wider(names_from = count_variable, values_from = count) %>%
  rename(cases = date_onset, deaths = date_death)

ebola_rt <- ebola_data_cfr %>%
  slice(1:150)

# Naive CFR
cfr_naive <- cfr::cfr_static(data = ebola_rt)

# Delay-adjusted CFR
# Getting distribution from {epiparameter}
onset_to_death_ebola <-
  epiparameter::epiparameter_db(
    disease = "Ebola",
    epi_name = "onset_to_death",
    single_epiparameter = TRUE
  )

cfr_adjusted <- cfr::cfr_static(data = ebola_rt, delay_density = function(x) density(onset_to_death_ebola, x))

# Create table with CFR estimates and confidence intervals
# Create table with CFR estimates and confidence intervals
cfr_table <- tibble(
  Method = c("Naive CFR", "Adjusted CFR"),
  Estimate = c(
    round(cfr_naive$severity_estimate, 2),
    round(cfr_adjusted$severity_estimate, 2)
  ),
  `Lower CI` = c(
    round(cfr_naive$severity_low, 2),
    round(cfr_adjusted$severity_low, 2)
  ),
  `Upper CI` = c(
    round(cfr_naive$severity_high, 2),
    round(cfr_adjusted$severity_high, 2)
  )
)

reactable(
  cfr_table,
  columns = list(
    Method = colDef(name = "Method"),
    Estimate = colDef(name = "Estimate")
  )
)

```
The naive CFR underestimates the case fatality risk by 7%.

# Estimating CFR over the course of an outbreak

We then estimate the case fatality risk at each time-point of the Ebola outbreak, including all available data.

```{r}
# Calculate the rolling daily naive CFR
rolling_cfr_naive <- cfr::cfr_rolling(data = ebola_data_cfr)

# Calculate the rolling daily delay-adjusted CFR
rolling_cfr_adjusted <- cfr::cfr_rolling(
  data = ebola_data_cfr,
  delay_density = function(x) density(onset_to_death_ebola, x)
)

# bind by rows both output data frames
dplyr::bind_rows(
  list(
    naive = rolling_cfr_naive,
    adjusted = rolling_cfr_adjusted
  ),
  .id = "method"
) %>%
  # visualise both adjusted and unadjusted rolling estimates
  ggplot() +
  geom_ribbon(
    aes(
      date,
      ymin = severity_low,
      ymax = severity_high,
      fill = method
    ),
    alpha = 0.2, show.legend = FALSE
  ) +
  geom_line(
    aes(date, severity_estimate, colour = method)
  ) +
  theme_bw()
```
The unadjusted, naive CFR underestimates the CFR significantly at the beginning of the outbreak, and approaches the delay-adjusted CFR values as the epidemic passes its peak and data on deaths becomes available.
