---
title: "Task 2: Generating interactive maps"
format:
  html:
    code-fold: true
execute:
  warning: false
  message: false
---

## Overview

This task focuses on creating interactive maps for visualizing spatial aspects of epidemiological data. You will learn how to work with spatial data, create maps using GIS tools in R, and visualize disease patterns geographically.

## Learning Objectives

- Work with spatial data formats (shapefiles, coordinates)
- Create interactive maps using GIS tools in R
- Visualize disease patterns and hotspots geographically
- Perform basic spatial analysis

## Tutorial

[Access the tutorial here](https://www.epirhandbook.com/en/new_pages/gis.html)

## Example Report

### Mapping Incidence

Total incidence to date was mapped by health-area.

```{r}

# INSTALL AND LOAD PACKAGES

# Load required packages
pacman::p_load(
  tidyverse,    # basic data manipulation
  sf,           # handling shapefiles
  here,         # handing file paths
  leaflet,      # mapping
  htmltools     # handlers for html objects
)


# LOAD DATA

# load shapefiles and keep relevant areas
shp <- sf::read_sf("data/gis/sle_adm3.shp") |>
  # standardize column names
  janitor::clean_names() |>
  # filter to keep certain areas
  filter(adm1_en == "Western")

# import the cleaned linelist data
linelist <- rio::import("data/linelist.rds") |>
  # interpret the lon and lat variables for GIS use
  st_as_sf(coords = c("lon", "lat"), crs = 4326) |>
  # join the administrative boundary file to the linelist, based on
  # spatial intersection
  st_join(shp, join = st_intersects)

# convert to aggregate format
agg <- linelist |>
  # remove the geometry for now
  st_drop_geometry() |>
  # count the number of cases per adm3
  summarise(n = n(), .by = adm3_en) |>
  # add the shape files of the adm3 zones
  inner_join(shp, by = "adm3_en") |>
  # convert back to shapefile
  st_as_sf()

# define colour palette
pal <- colorNumeric(palette = "YlOrRd", domain = agg$n)

# generate leaflet map
leaflet(agg) |>
  # use CartoDB for background
  addProviderTiles("CartoDB.Positron") |>
  # add adm3 shaded by number of cases
  addPolygons(
    fillColor = ~ pal(n),
    color = "white",
    weight = 1,
    fillOpacity = 0.7,
    # define labels
    label = ~ map(
      paste0("<b>", adm3_en, "</b><br>", n, " cases"),
      htmltools::HTML
    ),
    labelOptions = labelOptions(direction = "auto"),
    highlightOptions = highlightOptions(
      weight = 3,
      color = "black",
      bringToFront = FALSE
    )
  ) |>
  # add points per case
  addCircleMarkers(
    data = linelist,
    radius = 4,
    color = "black",
    fillColor = "grey",
    weight = 1,
    fillOpacity = 0.8,
    label = ~ map(
      paste0("<b>Case ID:</b> ", case_id, "<br>",
             "<b>Date onset:</b> ", date_onset, "<br>",
             "<b>Health facility:</b> ", hospital),
      htmltools::HTML
    ),
    labelOptions = labelOptions(direction = "auto"),
    group = "Cases"
  ) |>
  # add legend
  addLegend(
    pal = pal,
    values = ~ n,
    title = "Case count",
    opacity = 0.7,
    position = "bottomright"
  )

```

## Additional Resources

::: {.panel-tabset}

### R Handbook
Relevant chapters from the Epidemiologist R Handbook.

### Package Documentation
Package vignettes and documentation for relevant R packages.

:::

