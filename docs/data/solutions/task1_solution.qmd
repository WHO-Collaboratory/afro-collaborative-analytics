---
title: "Task 1 Solution"
format:
  html
execute:
  echo: false
  warning: false
  message: false
---


```{r}
# INSTALL AND LOAD PACKAGES

# Load required packages
pacman::p_load(
  tidyverse, # For data manipulation and visualization
  reactable, # For interactive tables
  lubridate, # For date handling
  apyramid # For age-sex pyramids
)


# LOAD DATA

# Import the cleaned linelist data from your local data folder
linelist <- readRDS("data/linelist.rds")


# SUMMARY STATISTICS

# Calculate first case month and peak month
first_case <- which.min(linelist$date_onset)
first_case_location <- paste0(linelist$adm3[first_case], ", ", linelist$adm2[first_case])
first_case_month <- format(linelist$date_onset[first_case], "%B %Y")

# Calculate month with most cases
monthly_cases <- linelist |>
  filter(!is.na(date_onset)) |>
  mutate(month = floor_date(date_onset, unit = "month")) |>
  count(month) |>
  arrange(desc(n))

# Extract monthly information
peak_month <- format(monthly_cases$month[1], "%B %Y")
peak_cases <- monthly_cases$n[1]

# Create summary table by adm3
adm3_summary <- linelist |>
  summarise(
    total_cases = n(),
    deaths = sum(outcome == "Death", na.rm = TRUE),
    .by = adm3
  ) |>
  arrange(desc(total_cases))

```

### Overview

The first case was reported in `r first_case_location` on `r first_case_month`. Case numbers increased to a maximum of `r peak_cases` cases in `r peak_month` before declining.

```{r}
# CREATE INCIDENCE CURVE

# Create incidence curve
incidence_curve <- linelist |>
  ggplot(aes(x = date_onset, fill = adm3)) +
  geom_histogram(binwidth = 7) +
  scale_fill_viridis_d(
    guide = guide_legend(reverse = FALSE),
    na.value = "grey"
  ) +
  labs(
    x = "Date of Onset",
    y = "Number of Cases",
    fill = "Chiefdom"
  ) +
  theme_minimal()

# Display the plot
incidence_curve

```

Summary statistics of case and deaths by chiefdom are provided below.

```{r}

# Create interactive table
reactable(
  adm3_summary,
  columns = list(
    adm3 = colDef(name = "Chiefdom"),
    total_cases = colDef(name = "Total Cases"),
    deaths = colDef(name = "Deaths")
  ),
  defaultPageSize = nrow(adm3_summary)
)
```


### Age and Sex Distribution

The age and sex distribution of cases was visualized to identify demographic patterns in the outbreak.

```{r}
# CREATE AGE-SEX PYRAMID

# Create age-sex pyramid using apyramid package
age_pyramid <- apyramid::age_pyramid(
  data = linelist,
  age_group = "age_cat",
  split_by = "gender",
  show_midpoint = FALSE
) +
  labs(
    title = NULL,
    x = "Age Group",
    y = "Number of Cases",
    fill = "Gender"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom"
  )

# Display the plot
age_pyramid

```

### Disease Severity

```{r}

# Calculate CFR (excluding NA outcomes)
cfr <- linelist |>
  filter(!is.na(outcome)) |>
  summarise(
    total_cases = n(),
    deaths = sum(outcome == "Death", na.rm = TRUE),
    recovered = sum(outcome == "Recover", na.rm = TRUE),
    unknown = sum(is.na(outcome)),
    cfr = round((deaths / (deaths + recovered)) * 100, 0)
  )

missing_outcome <- scales::percent(mean(is.na(linelist$outcome)))

```

The crude case fatality ratio (CFR) was estimated at `r cfr$cfr`%, though the outcome was unknown for `r missing_outcome` of cases. CFR estimates were also generated by health facility to identify potential facilities with significantly worse outcomes.

```{r}

# Create summary table by hospital
hospital_summary <- linelist |>
  # group missing and other hospitals
  mutate(
    hospital = modify_if(hospital, ~ .x %in% c("Other", "Missing"), ~"Other/Missing")
  ) |>
  summarise(
    total_cases = n(),
    deaths = sum(outcome == "Death", na.rm = TRUE),
    recovered = sum(outcome == "Recover", na.rm = TRUE),
    unknown = sum(is.na(outcome)),
    cfr = round((deaths / (deaths + recovered)) * 100, 0),
    .by = hospital
  )

# Create interactive table
reactable(
  hospital_summary,
  columns = list(
    hospital = colDef(name = "Hospital"),
    total_cases = colDef(name = "Total Cases"),
    deaths = colDef(name = "Deaths"),
    recovered = colDef(name = "Recovered"),
    unknown = colDef(name = "Unknown"),
    cfr = colDef(name = "CFR (%)")
  ),
  defaultPageSize = nrow(hospital_summary)
)

```
